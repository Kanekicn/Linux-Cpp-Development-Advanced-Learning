# 网络编程入门(2) 远方的你还在嘛？

问题：服务器由于一些原因崩溃，向客户端发送的FIN包由于异常情况，没有正常到达，导致客户端维持该连接（不会收到服务端的消息）。

客户端崩溃，服务器端在几天内都维护着一个无用的TCP连接。

原因：客户端没有及时对连接有效性进行检测。

解决方案：保证连接的有效性检测。

</br>

## 2.1 Keep-Alive 机制

为了避免上述问题的发生，TCP有一个保持活跃的机制：Keep-Alive。

Keep-Alive机制：定义一个时间段，如果在时间段内，没有任何连接相关的活动，TCP保活机制发挥作用，每隔一个时间间隔发送一个探测报文，如果连续几个探测报文没有得到相应，则认为TCP连接已经死亡，系统内核将错误信息通知给上层的应用程序。

在Linux系统中，上述时间段，时间间隔和探测次数分别为7200s，75s和9次。

开启TCP保活的三种探测情况：

1. 发送探测报文，对端正常响应。表明对端正常工作，重置TCP保活时间
2. 发送探测报文，对端响应RST报文。表明该连接不存在，但与对端有其他连接，可能由于对端程序崩溃，连接已被重置。
3. 发送探测报文，对端不响应。表明对端程序崩溃 / 其他原因导致播啊文不可达。

</br>

## 2.2 应用层探活

由于TCP的Keep-Alive机制，在Linux系统中，至少需要经过2小时11分15秒才能发现一个无效连接。对于时延敏感的系统，这个时间是无法容忍的。所以，需要在应用层进行探活。

设计一个 PING-PONG机制，当客户端到达保活时间后，发起对连接的PING操作，如果服务端对PING操作有回应，则重置保活时间，否则对探测次数进行计数，到达预先设置的次数后，则判定连接无效。

PING-PONG关键技术：

1. 定时器
2. PING-PONG协议















## 
# C++进阶(18) 对象模型

## 18.1 成员函数与成员变量

class 是特殊的struct

- class 与 struct 遵循相同的对其规则
- class  成员函数与成员变量是分开存放的
  - 每个对象有独立的成员变量
  - 所有对象共享类中的成员函数

> 实验18-1 class 与struct 内存对齐

运行时对象退化为结构体的形式：

- 所有成员变量在内存中依次排布
- 成员变量之间可能存在内存间隙
- 可以通过内存地址访问成员变量
- 访问权限关键字失效



成员函数：

- 类中成员函数位于代码段
- 调用成员函数时，对象地址作为参数隐式传递
- 成员函数通过地址访问成员变量
- C++语法规则隐藏了对象地址传递过程

</br>

## 18.2 this 指针

> 实验18-2 this 指针
>
> 实验18-3 C语言中struct 模拟this指针

</br>

## 18.3 继承对象模型

### 18.3.1 无虚函数

在继承体系下，子类的对象模型是由父类成员叠加子类新成员得到。

> 18-4 继承体系下的对象模型（内存分布）

</br>

### 18.3.2 虚类的对象模型

虚函数与多态：多态是面向对象的一个抽象概念，与具体语言无关，相同行为方式表现出不同的形态。在C++ 中，多态是由虚函数来实现的。

C++多态的实现原理

- 类中声明虚函数时，编译器会在类中生成一个虚函数表
- 虚函数表是一个存储成员函数地址指针的数据结构
- 虚函数是由编译器自动生成与维护的
- virtual 成员函数会被编译器放入虚函数表中
- 存在虚函数时，每个对象中都有一个指向虚函数表的指针

在类中含有虚函数时，子类对象和父类对象会被加入一个虚函数表，存放所有虚函数。在调用函数时，编译器会判断函数是否为虚函数？

1. 如果是虚函数，编译器会在对象VPTR所指向虚函数表中查找函数地址
2. 如果不是虚函数，编译器直接可以确定被调用函数的地址

虚函数的调用效率：虚函数 <  普通成员函数。

> 实验18-4 加入virtual 函数，类的大小加4







